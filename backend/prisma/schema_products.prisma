// =====================================================
// HIVE - Prisma Schema Session 2
// Products, Categories, Images, Inventory, Sync
// =====================================================

// Add these models to the existing schema.prisma

// =====================================================
// PRODUCT CATEGORIES
// =====================================================
model ProductCategory {
  id          String    @id @default(uuid())
  businessId  String    @map("business_id")
  
  name        String
  slug        String
  description String?
  imageUrl    String?   @map("image_url")
  
  parentId    String?   @map("parent_id")
  level       Int       @default(0)
  sortOrder   Int       @default(0) @map("sort_order")
  
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  business    BusinessProfile    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  parent      ProductCategory?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[]  @relation("CategoryHierarchy")
  products    Product[]
  
  @@unique([businessId, slug])
  @@index([businessId])
  @@index([parentId])
  @@map("product_categories")
}

// =====================================================
// PRODUCTS
// =====================================================
enum ProductStatus {
  draft
  active
  out_of_stock
  discontinued
}

model Product {
  id              String          @id @default(uuid())
  businessId      String          @map("business_id")
  categoryId      String?         @map("category_id")
  
  // Basic Info
  name            String
  slug            String
  description     String?
  shortDescription String?        @map("short_description")
  
  // Pricing
  price           Decimal         @db.Decimal(12, 2)
  compareAtPrice  Decimal?        @db.Decimal(12, 2) @map("compare_at_price")
  costPrice       Decimal?        @db.Decimal(12, 2) @map("cost_price")
  currency        String          @default("KES")
  
  // Inventory
  sku             String?
  barcode         String?
  trackInventory  Boolean         @default(true) @map("track_inventory")
  quantity        Int             @default(0)
  lowStockThreshold Int           @default(5) @map("low_stock_threshold")
  
  // Physical
  weight          Decimal?        @db.Decimal(10, 2)
  weightUnit      String          @default("kg") @map("weight_unit")
  
  // Status
  status          ProductStatus   @default(draft)
  isFeatured      Boolean         @default(false) @map("is_featured")
  
  // SEO
  metaTitle       String?         @map("meta_title")
  metaDescription String?         @map("meta_description")
  
  // Flexible attributes
  attributes      Json            @default("{}")
  tags            String[]        @default([])
  
  // Stats
  viewCount       Int             @default(0) @map("view_count")
  orderCount      Int             @default(0) @map("order_count")
  
  // Sync
  syncId          String?         @map("sync_id")
  lastSyncedAt    DateTime?       @map("last_synced_at")
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  
  // Relations
  business        BusinessProfile   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category        ProductCategory?  @relation(fields: [categoryId], references: [id])
  images          ProductImage[]
  variants        ProductVariant[]
  inventoryLogs   InventoryLog[]
  
  @@unique([businessId, slug])
  @@unique([businessId, sku])
  @@index([businessId])
  @@index([categoryId])
  @@index([status])
  @@index([syncId])
  @@map("products")
}

// =====================================================
// PRODUCT IMAGES
// =====================================================
model ProductImage {
  id            String    @id @default(uuid())
  productId     String    @map("product_id")
  
  url           String
  thumbnailUrl  String?   @map("thumbnail_url")
  altText       String?   @map("alt_text")
  
  sortOrder     Int       @default(0) @map("sort_order")
  isPrimary     Boolean   @default(false) @map("is_primary")
  
  width         Int?
  height        Int?
  fileSize      Int?      @map("file_size")
  mimeType      String?   @map("mime_type")
  
  syncId        String?   @map("sync_id")
  localPath     String?   @map("local_path")
  uploadStatus  String    @default("completed") @map("upload_status")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  variants      ProductVariant[]
  
  @@index([productId])
  @@map("product_images")
}

// =====================================================
// PRODUCT VARIANTS
// =====================================================
model ProductVariant {
  id              String    @id @default(uuid())
  productId       String    @map("product_id")
  
  name            String
  sku             String?
  barcode         String?
  
  price           Decimal   @db.Decimal(12, 2)
  compareAtPrice  Decimal?  @db.Decimal(12, 2) @map("compare_at_price")
  costPrice       Decimal?  @db.Decimal(12, 2) @map("cost_price")
  
  quantity        Int       @default(0)
  options         Json      @default("{}")
  
  imageId         String?   @map("image_id")
  
  isActive        Boolean   @default(true) @map("is_active")
  sortOrder       Int       @default(0) @map("sort_order")
  
  syncId          String?   @map("sync_id")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  product         Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  image           ProductImage?  @relation(fields: [imageId], references: [id])
  inventoryLogs   InventoryLog[]
  
  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

// =====================================================
// INVENTORY LOGS
// =====================================================
enum InventoryAction {
  set
  add
  subtract
  sale
  return_item @map("return")
  adjustment
  sync
}

model InventoryLog {
  id              String          @id @default(uuid())
  productId       String?         @map("product_id")
  variantId       String?         @map("variant_id")
  businessId      String          @map("business_id")
  
  action          InventoryAction
  quantityChange  Int             @map("quantity_change")
  quantityBefore  Int             @map("quantity_before")
  quantityAfter   Int             @map("quantity_after")
  
  reason          String?
  referenceType   String?         @map("reference_type")
  referenceId     String?         @map("reference_id")
  
  performedById   String?         @map("performed_by")
  
  createdAt       DateTime        @default(now()) @map("created_at")
  
  product         Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant         ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  business        BusinessProfile @relation(fields: [businessId], references: [id], onDelete: Cascade)
  performedBy     User?           @relation(fields: [performedById], references: [id])
  
  @@index([productId])
  @@index([businessId])
  @@index([createdAt])
  @@map("inventory_logs")
}

// =====================================================
// SYNC QUEUE
// =====================================================
enum SyncOperation {
  create
  update
  delete
}

enum SyncStatus {
  pending
  processing
  completed
  failed
  conflict
}

model SyncQueue {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  businessId      String?       @map("business_id")
  deviceId        String        @map("device_id")
  
  entityType      String        @map("entity_type")
  entityId        String        @map("entity_id")
  syncId          String        @map("sync_id")
  
  operation       SyncOperation
  payload         Json
  
  clientTimestamp DateTime      @map("client_timestamp")
  serverTimestamp DateTime      @default(now()) @map("server_timestamp")
  
  status          SyncStatus    @default(pending)
  errorMessage    String?       @map("error_message")
  retryCount      Int           @default(0) @map("retry_count")
  
  processedAt     DateTime?     @map("processed_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  business        BusinessProfile? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([userId, status])
  @@index([businessId])
  @@index([entityType, entityId])
  @@map("sync_queue")
}

// =====================================================
// SYNC CHECKPOINTS
// =====================================================
model SyncCheckpoint {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  businessId    String?   @map("business_id")
  deviceId      String    @map("device_id")
  
  entityType    String    @map("entity_type")
  lastSyncAt    DateTime  @map("last_sync_at")
  lastSyncId    String?   @map("last_sync_id")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  business      BusinessProfile? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([userId, businessId, deviceId, entityType])
  @@map("sync_checkpoints")
}

// =====================================================
// UPDATE EXISTING MODELS - Add relations
// =====================================================

// Add to BusinessProfile model:
// products        Product[]
// productCategories ProductCategory[]
// inventoryLogs   InventoryLog[]
// syncQueue       SyncQueue[]
// syncCheckpoints SyncCheckpoint[]

// Add to User model:
// inventoryLogs   InventoryLog[] @relation("InventoryPerformer")
// syncQueue       SyncQueue[]
// syncCheckpoints SyncCheckpoint[]
